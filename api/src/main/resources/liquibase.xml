<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
                  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">
    <!--
        See http://www.liquibase.org/manual/home#available_database_refactorings
        for a list of supported elements and attributes
    -->

    <changeSet id="disa-2022-11-29-10:41" author="yassin">
        <insert tableName="privilege">
            <column name="privilege">Manage VL Results</column>
            <column name="description">Able to create, read, update and destroy DISA viral load results.</column>
            <column name="uuid">d78d2826-f81c-4e55-a36a-3bf53d17e841</column>
        </insert>
    </changeSet>

    <changeSet id="disa-2023-01-05-10:43" author="yassin">
        <update tableName="privilege">
            <column name="privilege">Gerir resultados no Disa Interoperabilidade</column>
            <column name="description">Capaz de ler, actualizar e remover resultados de laboratório no Disa Interoperabilidade.</column>
            <where>uuid = 'd78d2826-f81c-4e55-a36a-3bf53d17e841'</where>
        </update>
    </changeSet>

    <changeSet id="disa-2023-01-05-11:19" author="yassin">
        <insert tableName="role">
            <column name="role">Gestor de Disa Interoperabilidade</column>
            <column name="uuid">58674fae-cdc3-4bab-b4e7-ec1a5954cfd2</column>
        </insert>
    </changeSet>

    <changeSet id="disa-2023-01-05-11:23" author="yassin">
        <insert tableName="role_privilege">
            <column name="role">Gestor de Disa Interoperabilidade</column>
            <column name="privilege">Gerir resultados no Disa Interoperabilidade</column>
        </insert>
    </changeSet>

    <changeSet id="disa-2023-01-06-12:51" author="yassin">
        <sql>
            update global_property
            set property_value=concat(property_value, ',', 'org.openmrs.module.disa:info')
            where property='log.level';
        </sql>
    </changeSet>

    <changeSet id="disa-2023-01-09-17:04" author="yassin">
        <insert tableName="role_role">
            <column name="parent_role">Data Manager</column>
            <column name="child_role">Gestor de Disa Interoperabilidade</column>
        </insert>
    </changeSet>

    <changeSet id="disa-2023-01-19-16:14" author="yassin">
        <insert tableName="privilege">
            <column name="privilege">Pesquisar resultados no Disa Interoperabilidade</column>
            <column name="description">Capaz de pesquisar resultados de laboratório no Disa Interoperabilidade.</column>
            <column name="uuid">a06f8b06-3c08-48df-a1ed-7d11358f3401</column>
        </insert>
    </changeSet>

    <changeSet id="disa-2023-01-19-16:20" author="yassin">
        <delete tableName="role_role">
            <where>parent_role = 'Data Manager' and child_role = 'Gestor de Disa Interoperabilidade'</where>
        </delete>
        <insert tableName="role_privilege">
            <column name="role">Gestor de Disa Interoperabilidade</column>
            <column name="privilege">Pesquisar resultados no Disa Interoperabilidade</column>
        </insert>
        <insert tableName="role_privilege">
            <column name="role">Tecnico de Laboratorio</column>
            <column name="privilege">Pesquisar resultados no Disa Interoperabilidade</column>
        </insert>
    </changeSet>

    <changeSet id="disa-2023-01-26-15:07" author="yassin">
        <insert tableName="privilege">
            <column name="privilege">Realocar resultados no Disa Interoperabilidade</column>
            <column name="description">Capaz de realocar resultados de laboratório no servidor de integração para outra unidade sanitária.</column>
            <column name="uuid">4b0d0d8a-606e-484e-be60-cb79e0057067</column>
        </insert>
        <insert tableName="privilege">
            <column name="privilege">Reagendar resultados no Disa Interoperabilidade</column>
            <column name="description">Capaz de reagendar resultados de laboratório no servidor de integração para serem processados em outra altura.</column>
            <column name="uuid">13ac99ff-b8b5-4830-97c0-8b467be920c7</column>
        </insert>
        <insert tableName="privilege">
            <column name="privilege">Remover resultados no Disa Interoperabilidade</column>
            <column name="description">Capaz de remover resultados de laboratório no servidor de integração.</column>
            <column name="uuid">cfa41ad9-4b8c-430f-8eaa-c2297afb1d76</column>
        </insert>
        <insert tableName="privilege">
            <column name="privilege">Mapear pacientes no Disa Interoperabilidade</column>
            <column name="description">Capaz de mapear pacientes cujo resultado de laboratório contenha NID incorrecto no servidor de integração.</column>
            <column name="uuid">27f2b9b7-d302-40a6-b41c-cb36355539a6</column>
        </insert>
        <delete tableName="role_privilege">
            <where>role = 'Gestor de Disa Interoperabilidade' and privilege = 'Gerir resultados no Disa Interoperabilidade'</where>
        </delete>
        <delete tableName="privilege">
            <where>privilege = 'Gerir resultados no Disa Interoperabilidade'</where>
        </delete>
        <insert tableName="role_privilege">
            <column name="role">Gestor de Disa Interoperabilidade</column>
            <column name="privilege">Realocar resultados no Disa Interoperabilidade</column>
        </insert>
        <insert tableName="role_privilege">
            <column name="role">Gestor de Disa Interoperabilidade</column>
            <column name="privilege">Reagendar resultados no Disa Interoperabilidade</column>
        </insert>
        <insert tableName="role_privilege">
            <column name="role">Gestor de Disa Interoperabilidade</column>
            <column name="privilege">Remover resultados no Disa Interoperabilidade</column>
        </insert>
        <insert tableName="role_privilege">
            <column name="role">Tecnico de Laboratorio</column>
            <column name="privilege">Mapear pacientes no Disa Interoperabilidade</column>
        </insert>
        <insert tableName="role_role">
            <column name="parent_role">Tecnico de Laboratorio</column>
            <column name="child_role">Gestor de Disa Interoperabilidade</column>
        </insert>
    </changeSet>

    <changeSet id="disa-2023-04-12-14:32" author="yassin">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM role_privilege WHERE role='Tecnico de Laboratorio' AND privilege='Reagendar resultados no Disa Interoperabilidade';
            </sqlCheck>
        </preConditions>
        <insert tableName="role_privilege">
            <column name="role">Tecnico de Laboratorio</column>
            <column name="privilege">Reagendar resultados no Disa Interoperabilidade</column>
        </insert>
    </changeSet>

    <changeSet id="disa-2023-05-09" author="yassin">
        <addColumn tableName="fsr_log">
            <column name="type_of_result" type="varchar(50)">
                <constraints nullable="false" />
            </column>
        </addColumn>
        <addUniqueConstraint tableName="fsr_log" columnNames="request_id, type_of_result" />
        <update tableName="fsr_log">
            <column name="type_of_result">HIVVL</column>
            <where>type_of_result is NULL</where>
        </update>
    </changeSet>
    
    <changeSet id="disa-2023-06-18-11:28" author="helio">
    	<insert tableName="global_property">
    		<column name="property">disa.api.notification.url</column>
    		<column name="property_value">https://disa-api.fgh.org.mz/notification</column> 
    		<column name="description">url notification endpoint</column> 
    		<column name="uuid">2686087c-871b-11e9-798c-0292ac129983</column>  
    	</insert>
    </changeSet>
    
    <changeSet id="delete-disa.api.mail.from" author="helio">
		<delete tableName="global_property">
			<where>property = 'disa.api.mail.from'</where> 
		</delete>
    </changeSet>
    
    <changeSet id="delete-disa.api.mail.from.password" author="helio">
		<delete tableName="global_property">
			<where>property = 'disa.api.mail.from.password'</where> 
		</delete>
    </changeSet>
    
    <changeSet id="delete-disa.api.mail.from.port" author="helio">
		<delete tableName="global_property">
			<where>property = 'disa.api.mail.from.port'</where> 
		</delete>
    </changeSet>
    
    <changeSet id="delete-disa.api.mail.host" author="helio">
		<delete tableName="global_property">
			<where>property = 'disa.api.mail.host'</where> 
		</delete>
    </changeSet>
    
    <changeSet id="delete-disa.api.mail.others.to" author="helio">
		<delete tableName="global_property">
			<where>property = 'disa.api.mail.others.to'</where> 
		</delete>
    </changeSet>
    	
</databaseChangeLog>
